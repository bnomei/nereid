# Design — DRAFT-39-stable-ids-across-renames

## Summary

We make **Mermaid-visible identifiers** (sequence participant names; flowchart node ids) **editable** without changing internal stable IDs used in `ObjectRef`s.

The core mechanism is a persisted mapping in each diagram sidecar:

- Sequence diagrams: `stable_id_map.by_name[<participant_mermaid_name>] = <stable_participant_id>`
- Flowcharts: `stable_id_map.by_mermaid_id[<node_mermaid_id>] = <stable_node_id>`

On load, we parse `.mmd` into an AST (which allocates ids based on Mermaid identifiers today), then **remap** parsed participants/nodes back to the stable ids recorded in the sidecar **before** reconciling messages/edges.

We assume `.mmd` is canonical-generated by Nereid (no manual edits required/expected).

## Current behavior (problem)

- Flowchart parsing derives `node_id = n:<mermaid_id>` and does not persist `FlowNode.mermaid_id`; export derives Mermaid ids by stripping `n:` from `node_id`. Renaming the Mermaid id implies changing the internal id.
- Sequence parsing derives `participant_id = p:<name>`. Renaming a participant updates `.mmd`, and a subsequent load produces a different `participant_id`.
- Persistence currently writes `stable_id_map: {}` on save, and load only reconciles:
  - flow edges (`reconcile_flowchart_edges`)
  - sequence messages (`reconcile_sequence_messages`)
  - notes
  - (not nodes/participants)

So after a rename, xrefs/walkthrough refs/selection that target participants/nodes can become dangling, and message/edge reconciliation becomes less reliable.

## Proposed changes

### 1) Persist `stable_id_map` on save (authoritative for generated `.mmd`)

In `SessionFolder::save_session`, compute `DiagramStableIdMap` from the in-memory AST:

- **Sequence diagrams**
  - For each `(participant_id, participant)`:
    - `by_name[participant.mermaid_name] = participant_id`
- **Flowcharts**
  - For each `(node_id, node)`:
    - Determine `node_mermaid_id`:
      - prefer `node.mermaid_id`
      - else (legacy) derive from `node_id` suffix if it is `n:<suffix>`
    - `by_mermaid_id[node_mermaid_id] = node_id`

Write the computed mapping into `<diagram>.meta.json`.

### 2) Reconcile nodes/participants on load using `stable_id_map`

Add two remap helpers in `src/store/session_folder.rs`:

- `reconcile_sequence_participants(ast: &mut SequenceAst, sidecar: &DiagramMeta)`
  - Build a remap `parsed_participant_id -> stable_participant_id`:
    - Key by `participant.mermaid_name()`
    - Lookup stable id from `sidecar.stable_id_map.by_name`
  - Rebuild `participants` map with stable ids.
  - Rewrite every `SequenceMessage.{from,to}_participant_id` using the remap.
  - Best-effort collision handling:
    - If two parsed participants map to the same stable id, keep the first deterministically and leave the other unchanged (or allocate a fresh stable id if you choose to support that); do not panic.

- `reconcile_flowchart_nodes(ast: &mut FlowchartAst, sidecar: &DiagramMeta)`
  - Determine each parsed node’s Mermaid id key (prefer `node.mermaid_id()`, else derive from `node_id` suffix).
  - Lookup stable node id from `sidecar.stable_id_map.by_mermaid_id`.
  - Rebuild `nodes` map with stable ids.
  - Rewrite:
    - `FlowEdge.{from,to}_node_id`
    - any node-group index maps (`node_groups`) if populated

**Load ordering matters**:

- Flowcharts: `reconcile_flowchart_nodes` → `reconcile_flowchart_edges` → `reconcile_flowchart_notes`
- Sequence: `reconcile_sequence_participants` → `reconcile_sequence_messages` → `reconcile_sequence_participant_notes`

This prevents edge/message reconciliation from drifting when endpoints were renamed.

### 3) Flowchart format: store and use `FlowNode.mermaid_id`

Update Mermaid flowchart parsing/export so the Mermaid id is a stored field:

- Parser: when seeing a Mermaid node id like `A`, set `FlowNode.mermaid_id = Some("A")`.
- Export: reference nodes by `FlowNode.mermaid_id` (fallback to legacy derive-from-`node_id` when `None`).

This enables a “rename Mermaid id” operation to affect `.mmd` output without changing stable ids.

### 4) Ops + MCP: rename flow node Mermaid id

Add a new structured op (diagram mutation) for flowcharts:

- `flow.set_node_mermaid_id { node_id, mermaid_id }`

Semantics:

- `node_id` (stable) does not change.
- `mermaid_id` must be:
  - Mermaid-ident valid (reuse existing `validate_mermaid_ident` logic if possible)
  - unique within the diagram

Expose via MCP as a new `McpOp` variant and map it through `diagram.apply_ops` / `diagram.propose_ops`.

Sequence participants already support `SeqUpdateParticipant { mermaid_name: … }`.

## Validation strategy

Add persistence regression tests (store-level) that simulate “rename then reload”:

- Sequence: participant id is stable but `mermaid_name` changes; after save/load, the participant id and any `ObjectRef`s remain stable, and messages still reference the stable ids.
- Flowchart: node id is stable but `mermaid_id` changes; after save/load, node id is stable, edges connect, and any xrefs remain non-dangling.

Run `cargo test`.

